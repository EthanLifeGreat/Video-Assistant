<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>bilibiliè§†é¢‘åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #4CAF50;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin: 20px 0;
        }

        form {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .input-group,
        .time-inputs {
            margin-bottom: 15px;
        }

        input[type="url"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .time-inputs {
            display: flex;
            gap: 15px;
        }

        .time-input-group {
            flex: 1;
        }

        .time-input-group label {
            display: block;
            margin-bottom: 5px;
        }

        .time-input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }

        .time-format-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        button {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }

        button:hover {
            background-color: #45a049;
        }

        .action-buttons,
        .preview-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-buttons button,
        .preview-controls button {
            flex: 1;
            width: auto;
        }

        .finish {
            background-color: #dc3545;
        }

        .finish:hover {
            background-color: #c82333;
        }

        .secondary,
        .reset-button {
            background-color: #6c757d;
        }

        .secondary:hover,
        .reset-button:hover {
            background-color: #5a6268;
        }

        .result,
        .preview-container,
        .segment-list {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .segment-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .segment-time {
            color: #666;
            font-size: 0.9em;
        }

        /* ç»Ÿä¸€é¢„è§ˆå’Œä¸‹è½½è§†é¢‘çš„æ ·å¼ */
        .preview-container video,
        .video-container video {
            width: 100%;
            max-width: 800px;
            display: block;
            margin: 0 auto;
        }

        .loading::after {
            content: "åŠ è½½ä¸­...";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%,
            20% {
                content: "åŠ è½½ä¸­.";
            }
            40% {
                content: "åŠ è½½ä¸­..";
            }
            60% {
                content: "åŠ è½½ä¸­...";
            }
            80%,
            100% {
                content: "åŠ è½½ä¸­....";
            }
        }

        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        .error {
            background-color: #ffebee;
            color: #b71c1c;
        }
    </style>
</head>
<body>
<!-- è¡¨å•åŒºåŸŸ -->
<h1>bilibiliè§†é¢‘åŠ©æ‰‹</h1>
<form id="videoForm" method="POST">
    <div class="input-group">
        <label for="input_field">è¯·è¾“å…¥è§†é¢‘é“¾æ¥ï¼š</label>
        <input
                type="url"
                id="input_field"
                name="user_input"
                required
                placeholder="https://www.bilibili.com/video/BV..."
                pattern="https?://.+"
                value="{{ input_data.url | default('') }}"
        />
    </div>

    <div class="time-inputs">
        <div class="time-input-group">
            <label>å¼€å§‹æ—¶é—´ï¼š</label>
            <input
                    type="text"
                    name="start_time"
                    class="time-input"
                    placeholder="00:00:00"
                    pattern="^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{1,2}$"
                    value="{{ input_data.start | default('') }}"
            />
            <div class="time-format-hint">æ ¼å¼ï¼šæ—¶:åˆ†:ç§’ æˆ– åˆ†:ç§’</div>
        </div>
        <div class="time-input-group">
            <label>ç»“æŸæ—¶é—´ï¼š</label>
            <input
                    type="text"
                    name="end_time"
                    class="time-input"
                    placeholder="00:00:00"
                    pattern="^([0-9]{1,2}:)?[0-9]{1,2}:[0-9]{1,2}$"
                    value="{{ input_data.end | default('') }}"
            />
            <div class="time-format-hint">æ ¼å¼ï¼šæ—¶:åˆ†:ç§’ æˆ– åˆ†:ç§’</div>
        </div>
    </div>

    <div class="action-buttons">
        <button type="button" id="previewBtn">é¢„è§ˆè§†é¢‘</button>
        <button type="submit">é¢„è§ˆç‰‡æ®µ</button>
        <button type="button" id="finishBtn" class="finish">å®Œæˆä¸‹è½½</button>
    </div>
    <div class="action-buttons" style="margin-top:20px; display: flex; gap: 15px; justify-content: space-between;">
        <button type="button" id="btnVocalRemove" style="flex: 1;">ä¼´å¥æå–</button>
        <button type="button" id="btnExtractSubtitle" style="flex: 1;">å­—å¹•æå–</button>
        <button type="button" id="btnEnhanceAudio" style="flex: 1;">äººå£°å¢å¼º</button>
    </div>
    <div class="action-buttons" style="margin-top:20px; display: flex; gap: 15px; justify-content: space-between;">
        <div id="vocalResult" style="flex: 1;"><h3>ğŸµ ä¼´å¥æå–</h3></div>
        <div id="subtitleResult" style="flex: 1;"><h3>ğŸ“„ å­—å¹•æå–</h3></div>
        <div id="enhanceResult" style="flex: 1;"><h3>ğŸ”Š äººå£°å¢å¼º</h3></div>
    </div>

</form>

<!-- çŠ¶æ€ä¸ç»“æœå±•ç¤º -->
<div id="progressBar" class="progress-bar">
    <div class="progress-bar-fill"></div>
</div>
<div id="statusMessage" class="status-message"></div>
<div id="loading" class="loading" role="status" aria-live="polite"></div>
<div id="previewContainer" class="preview-container"></div>
<div id="segmentList" class="segment-list"></div>
<div id="videoContainer" class="video-container"></div>
<div id="errorMsg" class="error"></div>
<div id="result"></div>


<button type="button" id="resetBtn" class="reset-button">é‡ç½®</button>

<!-- è„šæœ¬åŠŸèƒ½æ¨¡å—åŒ–é‡æ„ -->
<script>
    const $ = (id) => document.getElementById(id);

    const showStatus = (msg, type = "info") => {
        const box = $("statusMessage");
        box.textContent = msg;
        box.className = `status-message ${type}`;
        box.style.display = "block";
        setTimeout(() => (box.style.display = "none"), 3000);
    };

    const resetState = () => {
        $("previewContainer").innerHTML = "";
        $("videoContainer").innerHTML = "";
        $("segmentList").innerHTML = "";
        $("errorMsg").innerText = "";
        $("input_field").value = "";
        document.querySelector('[name="start_time"]').value = "";
        document.querySelector('[name="end_time"]').value = "";
        showStatus("å·²é‡ç½®", "success");
    };

    const timeToSeconds = (time) => {
        if (!time) return null;
        const parts = time.split(":").map(Number);
        if (parts.some(isNaN)) return null;
        return parts.length === 2
            ? parts[0] * 60 + parts[1]
            : parts[0] * 3600 + parts[1] * 60 + parts[2];
    };

    const secondsToTime = (sec) => {
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = Math.floor(sec % 60);
        return h > 0
            ? `${h}:${m.toString().padStart(2, "0")}:${s
                .toString()
                .padStart(2, "0")}`
            : `${m}:${s.toString().padStart(2, "0")}`;
    };

    const updateSegmentList = (segments) => {
        const list = $("segmentList");
        if (!segments || segments.length === 0) return (list.innerHTML = "");
        list.innerHTML =
            `<h3>å¯ä¸‹è½½ç‰‡æ®µ</h3>` +
            segments
                .map(
                    (seg) => `
            <div class="segment-item">
              <div class="segment-info">
                <div>${seg.title}</div>
                <div class="segment-time">${secondsToTime(seg.start)} - ${secondsToTime(
                        seg.end
                    )}</div>
              </div>
              <video controls width="200" src="${seg.url}"></video>
            </div>`
                )
                .join("");
    };

    const fetchJSON = async (url, data) => {
        const res = await fetch(url, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(data),
        });
        const json = await res.json();
        return {ok: res.ok, data: json};
    };

    let currentVideoTitle = "";

    // å‘é€è§†é¢‘å¤„ç†è¯·æ±‚çš„é€šç”¨å‡½æ•°
    async function callVideoProcess(action) {
        const url = $("input_field").value.trim();
        if (!url) {
            $("errorMsg").innerText = "è¯·å…ˆè¾“å…¥è§†é¢‘é“¾æ¥";
            return;
        }

        $("loading").style.display = "block";
        showStatus(`æ­£åœ¨æ‰§è¡Œã€${action}ã€‘æ“ä½œ...`, "info");

        try {
            const res = await fetch("/api/video_process", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({action, video_url: url})
            });

            $("loading").style.display = "none";

            const result = await res.json();
            console.log("å¤„ç†ç»“æœï¼š", result);  // âœ… è¾“å‡ºåç«¯è¿”å›

            if (!res.ok || !result.success) {
                showStatus(result.message || "å¤„ç†å¤±è´¥", "error");
                return;
            }

            let container;
            if (action === "vocal_remove") container = $("vocalResult");
            else if (action === "extract_subtitle") container = $("subtitleResult");
            else if (action === "enhance_audio") container = $("enhanceResult");

            container.innerHTML = `
            <a href="${result.download_url}" download target="_blank">ç‚¹å‡»ä¸‹è½½æ–‡ä»¶</a>
            `;


            showStatus(`ã€${action}ã€‘å¤„ç†å®Œæˆ`, "success");

        } catch (err) {
            $("loading").style.display = "none";
            showStatus("è¯·æ±‚å¤±è´¥ï¼š" + err.message, "error");
        }
    }


    // ç»‘å®š3ä¸ªæŒ‰é’®äº‹ä»¶
    $("btnVocalRemove").onclick = () => callVideoProcess("vocal_remove");
    $("btnExtractSubtitle").onclick = () => callVideoProcess("extract_subtitle");
    $("btnEnhanceAudio").onclick = () => callVideoProcess("enhance_audio");


    $("previewBtn").onclick = async () => {
        const url = $("input_field").value;
        if (!url) return ($("errorMsg").innerText = "è¯·è¾“å…¥è§†é¢‘é“¾æ¥");

        $("loading").style.display = "block";
        showStatus("æ­£åœ¨åŠ è½½è§†é¢‘...", "info");

        const {ok, data} = await fetchJSON("/api/preview_video", {url});
        $("loading").style.display = "none";

        if (!ok) return showStatus(data.error || "é¢„è§ˆå¤±è´¥", "error");

        currentVideoTitle = data.title;
        $("previewContainer").innerHTML = `<h3>${data.title}</h3><video controls src="${data.video_url}"></video>`;
        showStatus("è§†é¢‘åŠ è½½å®Œæˆ", "success");

        const segRes = await fetchJSON("/api/get_segments", {title: data.title});
        if (segRes.ok) updateSegmentList(segRes.data.segments);
    };

    $("finishBtn").onclick = async () => {
        if (!currentVideoTitle) return ($("errorMsg").innerText = "è¯·å…ˆé¢„è§ˆè§†é¢‘");

        $("loading").style.display = "block";
        const {ok, data} = await fetchJSON("/api/finish_download", {
            title: currentVideoTitle,
        });
        $("loading").style.display = "none";

        if (ok) {
            showStatus("å®Œæˆå½“å‰ä¸‹è½½ï¼Œç‚¹å‡»é‡ç½®ç»§ç»­ä¸‹è½½", "success");
            $("previewContainer").innerHTML = "";
            currentVideoTitle = "";
        } else {
            showStatus(data.error || "æ“ä½œå¤±è´¥", "error");
        }
    };

    $("resetBtn").onclick = resetState;

    $("videoForm").onsubmit = async (e) => {
        e.preventDefault();
        const url = $("input_field").value;
        const start = timeToSeconds(document.querySelector('[name="start_time"]').value);
        const end = timeToSeconds(document.querySelector('[name="end_time"]').value);

        $("loading").style.display = "block";
        $("progressBar").style.display = "block";
        showStatus("æ­£åœ¨å¤„ç†è§†é¢‘ç‰‡æ®µ...", "info");

        const {ok, data} = await fetchJSON("/api/get_video", {url, start, end});

        $("loading").style.display = "none";
        $("progressBar").style.display = "none";

        if (ok) {
            $("videoContainer").innerHTML = `<h3>${data.title}</h3><video controls src="${data.video_url}"></video>`;
            showStatus("ç‰‡æ®µä¸‹è½½å®Œæˆ", "success");
            if (data.segments) updateSegmentList(data.segments);
        } else {
            showStatus(data.error || "ä¸‹è½½å¤±è´¥", "error");
        }
    };
</script>
</body>
</html>
